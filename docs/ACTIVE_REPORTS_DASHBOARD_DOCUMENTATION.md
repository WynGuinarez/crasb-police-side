# Active Reports Dashboard - Complete Documentation

## Overview

A complete, single-file Angular application that implements a Real-Time Active Reports Dashboard with integrated Per-Report Chat functionality using Firebase Firestore.

---

## Table of Contents

1. [Architecture](#architecture)
2. [Data Models](#data-models)
3. [Firestore Collection Structure](#firestore-collection-structure)
4. [Features](#features)
5. [Component Structure](#component-structure)
6. [API Endpoints (Firestore Operations)](#api-endpoints-firestore-operations)
7. [Usage Guide](#usage-guide)
8. [Security Rules](#security-rules)

---

## Architecture

### Technology Stack
- **Framework**: Angular (Standalone Components)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Database**: Firebase Firestore
- **Real-time**: Firestore onSnapshot listeners
- **Authentication**: Firebase Authentication (Custom Token)

### Global Variables Required

The application expects the following global variables to be available on the `window` object:

```typescript
window.__app_id: string              // Application identifier
window.__firebase_config: object     // Firebase configuration object
window.__initial_auth_token: string  // Optional: Custom authentication token
```

---

## Data Models

### Report Interface

```typescript
interface Report {
  id?: string;                    // Document ID (auto-generated by Firestore)
  reportId: string;               // Unique report identifier (required)
  category: string;                // Report category (e.g., 'Crime', 'Fire', 'Medical', 'Traffic')
  location: string;                // Report location (required)
  status: string;                  // Report status (e.g., 'Pending', 'Acknowledged', 'En Route', 'Resolved', 'Canceled')
  time: Timestamp;                 // Firestore Timestamp (required)
}
```

### Chat Message Interface

```typescript
interface ChatMessage {
  id?: string;                    // Document ID (auto-generated by Firestore)
  text: string;                   // Message content (required, max 500 chars)
  timestamp: Timestamp;            // Firestore Timestamp (required)
  senderType: 'police' | 'sender'; // Message sender type (required)
}
```

---

## Firestore Collection Structure

### Reports Collection

**Path**: `/artifacts/{__app_id}/public/data/active_reports`

**Example**: If `__app_id = "crash-app"`, the path would be:
```
/artifacts/crash-app/public/data/active_reports
```

### Chat Subcollection (Per Report)

**Path**: `/artifacts/{__app_id}/public/data/active_reports/{reportId}/chats`

**Example**: For report with `reportId = "RPT-001"`:
```
/artifacts/crash-app/public/data/active_reports/RPT-001/chats
```

**Key Points**:
- Each report has its own unique chat subcollection
- Chat messages are isolated per report
- Multiple reports can have active chats simultaneously

---

## Features

### ✅ Real-Time Reports Dashboard

1. **Real-time Updates**: Uses `onSnapshot` to listen for changes
2. **Table Display**: Shows Category, Location, Status, Time, and Actions
3. **No Distance/ETA Columns**: As per requirements, these columns are excluded
4. **Automatic Sorting**: Reports ordered by time (newest first)

### ✅ Per-Report Chat System

1. **Unique Chat Sessions**: Each report has its own chat subcollection
2. **Real-time Messages**: Chat messages update in real-time using `onSnapshot`
3. **Role Switching**: Users can toggle between 'Police' and 'Sender' roles
4. **Message Ordering**: Messages ordered by timestamp (oldest first, newest at bottom)
5. **Visual Styling**:
   - Police messages: Blue bubbles, right-aligned
   - Sender messages: Gray bubbles, left-aligned
6. **Modal Interface**: Chat opens in a modal overlay

### ✅ User Interface

1. **Responsive Design**: Works on desktop and mobile devices
2. **Loading States**: Shows loading indicators during data fetch
3. **Error Handling**: Displays user-friendly error messages
4. **Auto-scroll**: Chat automatically scrolls to latest message

---

## Component Structure

### ActiveReportsDashboardComponent

**File**: `active-reports-dashboard.component.ts`

**Key Methods**:

1. **`ngOnInit()`**: Initializes Firebase and sets up reports listener
2. **`ngOnDestroy()`**: Cleans up Firestore listeners
3. **`initializeFirebase()`**: Sets up Firebase connection
4. **`setupReportsListener()`**: Creates real-time listener for reports
5. **`openChat(report)`**: Opens chat modal for a specific report
6. **`closeChat()`**: Closes chat modal and unsubscribes from chat listener
7. **`setupChatListener(reportId)`**: Sets up real-time listener for chat messages
8. **`sendChatMessage()`**: Sends a new message to the chat subcollection
9. **`setChatRole(role)`**: Changes the current sending role
10. **`formatTimestamp()`**: Formats timestamps for display
11. **`formatChatTimestamp()`**: Formats chat message timestamps

**State Management**:

- **Reports State**: `reports[]`, `loading`, `error`
- **Chat State**: `showChatModal`, `selectedReport`, `chatMessages[]`, `currentChatRole`, `chatMessageText`, `chatLoading`, `chatError`, `chatInitialized`

---

## API Endpoints (Firestore Operations)

### 1. Read Reports (Real-time)

**Operation**: Listen to all active reports

**Collection Path**: `/artifacts/{__app_id}/public/data/active_reports`

**Query**: Ordered by `time` (descending)

**Method**: `onSnapshot()`

**Response**: Real-time updates via callback

**Example**:
```typescript
const reportsCollection = collection(firestore, `artifacts/${appId}/public/data/active_reports`);
const reportsQuery = query(reportsCollection, orderBy('time', 'desc'));

const unsubscribe = onSnapshot(reportsQuery, (snapshot) => {
  const reports = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
});
```

---

### 2. Read Chat Messages (Real-time)

**Operation**: Listen to chat messages for a specific report

**Collection Path**: `/artifacts/{__app_id}/public/data/active_reports/{reportId}/chats`

**Query**: Ordered by `timestamp` (ascending)

**Method**: `onSnapshot()`

**Response**: Real-time updates via callback

**Example**:
```typescript
const chatCollection = collection(
  firestore, 
  `artifacts/${appId}/public/data/active_reports/${reportId}/chats`
);
const chatQuery = query(chatCollection, orderBy('timestamp', 'asc'));

const unsubscribe = onSnapshot(chatQuery, (snapshot) => {
  const messages = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
});
```

---

### 3. Create Chat Message

**Operation**: Add a new message to a report's chat subcollection

**Collection Path**: `/artifacts/{__app_id}/public/data/active_reports/{reportId}/chats`

**Method**: `addDoc()`

**Request Payload**:
```typescript
{
  text: string;                   // Message content
  timestamp: Timestamp;            // Current timestamp
  senderType: 'police' | 'sender' // Sender role
}
```

**Example**:
```typescript
const chatCollection = collection(
  firestore, 
  `artifacts/${appId}/public/data/active_reports/${reportId}/chats`
);

const newMessage = {
  text: "Hello, this is a test message",
  timestamp: Timestamp.now(),
  senderType: 'police'
};

await addDoc(chatCollection, newMessage);
```

---

## Usage Guide

### 1. Installation

```bash
npm install @angular/fire firebase
```

### 2. Set Global Variables

**In `index.html` or `main.ts`**:

```typescript
(window as any).__app_id = 'your-app-id';
(window as any).__firebase_config = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};
(window as any).__initial_auth_token = 'your-custom-token'; // Optional
```

### 3. Import Component

```typescript
import { ActiveReportsDashboardComponent } from './active-reports-dashboard.component';

@NgModule({
  imports: [
    ActiveReportsDashboardComponent,
    // ... other imports
  ],
})
export class YourModule { }
```

### 4. Use in Template

```html
<app-active-reports-dashboard></app-active-reports-dashboard>
```

---

## Security Rules

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Reports collection
    match /artifacts/{appId}/public/data/active_reports/{reportId} {
      // Allow read if authenticated
      allow read: if request.auth != null;
      
      // Allow write if authenticated and data is valid
      allow write: if request.auth != null 
                   && request.resource.data.reportId is string
                   && request.resource.data.category is string
                   && request.resource.data.location is string
                   && request.resource.data.status is string
                   && request.resource.data.time is timestamp;
      
      // Chat subcollection
      match /chats/{messageId} {
        // Allow read if authenticated
        allow read: if request.auth != null;
        
        // Allow write if authenticated and data is valid
        allow write: if request.auth != null 
                     && request.resource.data.text is string
                     && request.resource.data.text.size() > 0
                     && request.resource.data.text.size() <= 500
                     && request.resource.data.senderType in ['police', 'sender']
                     && request.resource.data.timestamp is timestamp;
      }
    }
  }
}
```

---

## Data Flow

### Reports Flow

```
Firestore Collection
  ↓
onSnapshot Listener
  ↓
Component State Update
  ↓
UI Re-render
```

### Chat Flow

```
User Clicks "Open Chat"
  ↓
Open Chat Modal
  ↓
Setup Chat Listener (report-specific subcollection)
  ↓
Real-time Message Updates
  ↓
User Sends Message
  ↓
addDoc to Chat Subcollection
  ↓
onSnapshot Triggers Update
  ↓
UI Updates with New Message
```

---

## UI Components

### Dashboard Table

**Columns**:
1. **Category**: Badge with color coding
2. **Location**: Text display
3. **Status**: Badge with color coding
4. **Time**: Formatted timestamp
5. **Actions**: "Open Chat" button

### Chat Modal

**Sections**:
1. **Header**: Report ID, Category, Location, Close button
2. **Role Selection**: Toggle between Police/Sender
3. **Messages Container**: Scrollable message list
4. **Input Section**: Text input and Send button

---

## Styling

### Category Badges
- **Crime**: Red (`bg-red-100 text-red-800`)
- **Fire**: Orange (`bg-orange-100 text-orange-800`)
- **Medical**: Green (`bg-green-100 text-green-800`)
- **Traffic**: Yellow (`bg-yellow-100 text-yellow-800`)

### Status Badges
- **Pending**: Yellow (`bg-yellow-100 text-yellow-800`)
- **Acknowledged**: Blue (`bg-blue-100 text-blue-800`)
- **En Route**: Purple (`bg-purple-100 text-purple-800`)
- **Resolved**: Green (`bg-green-100 text-green-800`)
- **Canceled**: Red (`bg-red-100 text-red-800`)

### Chat Messages
- **Police**: Blue bubble (`bg-blue-500 text-white`), right-aligned
- **Sender**: Gray bubble (`bg-gray-300 text-gray-800`), left-aligned

---

## Error Handling

### Common Errors

1. **Firebase Not Initialized**: Check global variables
2. **Permission Denied**: Verify Firestore security rules
3. **Network Issues**: Check internet connection
4. **Invalid Report ID**: Ensure reportId exists before opening chat

### Error Display

- Errors are shown in red banners
- Loading states prevent user interaction during fetch
- Auto-dismiss for transient errors (5 seconds)

---

## Performance Considerations

1. **Efficient Queries**: Single query per collection with ordering
2. **Memory Management**: Proper cleanup of listeners in `ngOnDestroy`
3. **Lazy Loading**: Chat listener only set up when modal opens
4. **Change Detection**: Angular's change detection handles updates automatically

---

## Testing Recommendations

### Unit Tests
- Component initialization
- Firebase connection
- Message sending logic
- Role switching
- Timestamp formatting

### Integration Tests
- Real-time listener updates
- Chat subcollection creation
- Multiple report chats
- Error handling

### E2E Tests
- Complete dashboard flow
- Open chat for multiple reports
- Send messages as different roles
- Real-time message updates

---

## Version Information

- **Document Version**: 1.0
- **Last Updated**: 2024
- **Angular Version**: 17+
- **Firebase SDK Version**: 10+

---

## Support & Troubleshooting

### Common Issues

1. **Reports not appearing**: Check Firestore rules and authentication
2. **Chat not loading**: Verify reportId is valid and subcollection path is correct
3. **Messages not sending**: Check Firestore write permissions
4. **Real-time updates not working**: Verify onSnapshot listeners are properly set up

### Debugging Tips

1. Check browser console for Firebase errors
2. Verify global variables are set before component initialization
3. Test Firestore rules using Firebase Console Rules Playground
4. Check network tab for Firestore requests

---

**End of Documentation**

