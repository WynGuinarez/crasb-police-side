# Police-Sender Chat System - API Documentation

## Overview

This document describes the API endpoints and data structures for the Police-Sender Chat System, a real-time, two-party chat application using Firebase Firestore for persistent storage.

---

## Table of Contents

1. [System Architecture](#system-architecture)
2. [Firebase Configuration](#firebase-configuration)
3. [Data Models](#data-models)
4. [Firestore Collection Structure](#firestore-collection-structure)
5. [API Endpoints (Firestore Operations)](#api-endpoints-firestore-operations)
6. [Real-time Listeners](#real-time-listeners)
7. [Authentication](#authentication)
8. [Error Handling](#error-handling)
9. [Usage Examples](#usage-examples)

---

## System Architecture

### Technology Stack
- **Frontend Framework**: Angular (Standalone Components)
- **Database**: Firebase Firestore
- **Authentication**: Firebase Authentication (Custom Token)
- **Styling**: Tailwind CSS
- **Real-time Updates**: Firestore onSnapshot listeners

### Global Variables Required

The application expects the following global variables to be available on the `window` object:

```typescript
window.__app_id: string              // Application identifier
window.__firebase_config: object     // Firebase configuration object
window.__initial_auth_token: string  // Optional: Custom authentication token
```

---

## Firebase Configuration

### Configuration Object Structure

```typescript
interface FirebaseConfig {
  apiKey: string;
  authDomain: string;
  projectId: string;
  storageBucket: string;
  messagingSenderId: string;
  appId: string;
  measurementId?: string;
}
```

### Example Configuration

```javascript
window.__firebase_config = {
  apiKey: "AIzaSyExample123",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};
```

---

## Data Models

### ChatMessage Interface

```typescript
interface ChatMessage {
  id?: string;                    // Document ID (auto-generated by Firestore)
  text: string;                   // Message content (required, max 500 chars)
  timestamp: Timestamp;            // Firestore Timestamp (required)
  senderType: 'police' | 'sender'; // Message sender type (required)
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | `string` | No | Auto-generated document ID by Firestore |
| `text` | `string` | Yes | The chat message content (max 500 characters) |
| `timestamp` | `Timestamp` | Yes | Firestore Timestamp representing when the message was sent |
| `senderType` | `'police' \| 'sender'` | Yes | Identifies the sender role |

---

## Firestore Collection Structure

### Collection Path

```
/artifacts/{__app_id}/public/data/police_sender_chats
```

### Path Components

- `artifacts`: Root collection for application artifacts
- `{__app_id}`: Dynamic segment using the global `__app_id` variable
- `public`: Public data namespace
- `data`: Data storage namespace
- `police_sender_chats`: Chat messages collection

### Example Path

If `__app_id = "crash-police-app"`, the full path would be:
```
/artifacts/crash-police-app/public/data/police_sender_chats
```

---

## API Endpoints (Firestore Operations)

### 1. Create Message (POST)

**Operation**: Add a new message document to the collection

**Method**: `addDoc()`

**Collection Path**: `/artifacts/{__app_id}/public/data/police_sender_chats`

**Request Payload**:
```typescript
{
  text: string;                   // Message content
  timestamp: Timestamp;            // Current timestamp
  senderType: 'police' | 'sender'  // Sender role
}
```

**Response**: 
- Success: Document reference with auto-generated ID
- Error: Firestore error object

**Example**:
```typescript
const messagesCollection = collection(
  firestore, 
  `artifacts/${appId}/public/data/police_sender_chats`
);

const newMessage = {
  text: "Hello, this is a test message",
  timestamp: Timestamp.now(),
  senderType: 'police'
};

const docRef = await addDoc(messagesCollection, newMessage);
console.log('Message ID:', docRef.id);
```

**Error Codes**:
- `permission-denied`: User doesn't have write permissions
- `unavailable`: Firestore service unavailable
- `unauthenticated`: User not authenticated

---

### 2. Read Messages (GET)

**Operation**: Query all messages ordered by timestamp

**Method**: `query()` with `orderBy()`

**Collection Path**: `/artifacts/{__app_id}/public/data/police_sender_chats`

**Query Parameters**:
- Order by: `timestamp` (ascending)
- Limit: None (all messages)

**Response**: Array of message documents

**Example**:
```typescript
const messagesCollection = collection(
  firestore, 
  `artifacts/${appId}/public/data/police_sender_chats`
);

const messagesQuery = query(
  messagesCollection, 
  orderBy('timestamp', 'asc')
);

const snapshot = await getDocs(messagesQuery);
const messages = snapshot.docs.map(doc => ({
  id: doc.id,
  ...doc.data()
}));
```

---

### 3. Real-time Message Listener (WebSocket-like)

**Operation**: Subscribe to real-time updates using `onSnapshot()`

**Method**: `onSnapshot()`

**Collection Path**: `/artifacts/{__app_id}/public/data/police_sender_chats`

**Query**: Same as Read Messages query

**Response**: Real-time updates via callback function

**Example**:
```typescript
const messagesCollection = collection(
  firestore, 
  `artifacts/${appId}/public/data/police_sender_chats`
);

const messagesQuery = query(
  messagesCollection, 
  orderBy('timestamp', 'asc')
);

const unsubscribe = onSnapshot(
  messagesQuery,
  (snapshot) => {
    const messages = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    // Handle updated messages
  },
  (error) => {
    // Handle error
  }
);

// To unsubscribe:
unsubscribe();
```

**Event Types**:
- `added`: New message added
- `modified`: Existing message modified
- `removed`: Message deleted

---

## Real-time Listeners

### onSnapshot Behavior

The application uses Firestore's `onSnapshot` listener to provide real-time updates:

1. **Initial Load**: Fires immediately with current collection state
2. **Real-time Updates**: Automatically fires on any document changes
3. **Ordering**: Messages are always ordered by `timestamp` in ascending order
4. **Unsubscribe**: Must be unsubscribed in component `ngOnDestroy` to prevent memory leaks

### Listener Lifecycle

```typescript
// Setup (in ngOnInit)
const unsubscribe = onSnapshot(query, onNext, onError);

// Cleanup (in ngOnDestroy)
unsubscribe();
```

---

## Authentication

### Custom Token Authentication

The application supports Firebase Authentication using custom tokens:

**Global Variable**: `window.__initial_auth_token`

**Authentication Flow**:
```typescript
import { getAuth, signInWithCustomToken } from '@angular/fire/auth';

const auth = getAuth();
await signInWithCustomToken(auth, window.__initial_auth_token);
```

**Security Rules Example** (Firestore):

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/police_sender_chats/{messageId} {
      // Allow read if authenticated
      allow read: if request.auth != null;
      
      // Allow write if authenticated
      allow write: if request.auth != null 
                   && request.resource.data.text is string
                   && request.resource.data.text.size() <= 500
                   && request.resource.data.senderType in ['police', 'sender']
                   && request.resource.data.timestamp is timestamp;
    }
  }
}
```

---

## Error Handling

### Common Error Scenarios

#### 1. Firebase Not Initialized
**Error**: `Firebase configuration (__firebase_config) is not provided`
**Solution**: Ensure `window.__firebase_config` is set before component initialization

#### 2. App ID Missing
**Error**: `App ID (__app_id) is not provided`
**Solution**: Ensure `window.__app_id` is set

#### 3. Permission Denied
**Error**: `permission-denied`
**Solution**: Check Firestore security rules and authentication status

#### 4. Network Issues
**Error**: `unavailable` or network timeout
**Solution**: Check internet connection and Firebase service status

### Error Display

Errors are displayed in the UI with:
- Red background banner
- Error message
- Auto-dismiss after 5 seconds (for send errors)

---

## Usage Examples

### Complete Setup Example

```html
<!DOCTYPE html>
<html>
<head>
  <title>Police-Sender Chat</title>
  <script>
    // Set global Firebase variables
    window.__app_id = 'crash-police-app';
    window.__firebase_config = {
      apiKey: "AIzaSyExample123",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef"
    };
    window.__initial_auth_token = 'your-custom-token-here'; // Optional
  </script>
</head>
<body>
  <app-root></app-root>
</body>
</html>
```

### Sending a Message Programmatically

```typescript
import { Firestore, collection, addDoc, Timestamp } from '@angular/fire/firestore';

async function sendMessage(
  firestore: Firestore, 
  appId: string, 
  text: string, 
  senderType: 'police' | 'sender'
) {
  const messagesCollection = collection(
    firestore, 
    `artifacts/${appId}/public/data/police_sender_chats`
  );
  
  const newMessage = {
    text: text,
    timestamp: Timestamp.now(),
    senderType: senderType
  };
  
  try {
    const docRef = await addDoc(messagesCollection, newMessage);
    console.log('Message sent with ID:', docRef.id);
    return docRef.id;
  } catch (error) {
    console.error('Error sending message:', error);
    throw error;
  }
}
```

### Reading Messages (One-time)

```typescript
import { Firestore, collection, query, orderBy, getDocs } from '@angular/fire/firestore';

async function getMessages(firestore: Firestore, appId: string) {
  const messagesCollection = collection(
    firestore, 
    `artifacts/${appId}/public/data/police_sender_chats`
  );
  
  const messagesQuery = query(
    messagesCollection, 
    orderBy('timestamp', 'asc')
  );
  
  const snapshot = await getDocs(messagesQuery);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
}
```

### Real-time Listener Setup

```typescript
import { Firestore, collection, query, orderBy, onSnapshot } from '@angular/fire/firestore';

function setupMessageListener(
  firestore: Firestore, 
  appId: string,
  onMessagesUpdate: (messages: ChatMessage[]) => void
) {
  const messagesCollection = collection(
    firestore, 
    `artifacts/${appId}/public/data/police_sender_chats`
  );
  
  const messagesQuery = query(
    messagesCollection, 
    orderBy('timestamp', 'asc')
  );
  
  return onSnapshot(
    messagesQuery,
    (snapshot) => {
      const messages = snapshot.docs.map(doc => ({
        id: doc.id,
        text: doc.data()['text'],
        timestamp: doc.data()['timestamp'],
        senderType: doc.data()['senderType']
      }));
      onMessagesUpdate(messages);
    },
    (error) => {
      console.error('Listener error:', error);
    }
  );
}
```

---

## Data Flow Diagram

```
┌─────────────┐
│   User      │
│  Interface  │
└──────┬──────┘
       │
       │ 1. User types message
       │ 2. Selects role (police/sender)
       │ 3. Clicks Send
       ▼
┌─────────────────────┐
│  Angular Component  │
│  (Chat Component)   │
└──────┬──────────────┘
       │
       │ 4. Validates input
       │ 5. Creates message object
       │ 6. Calls addDoc()
       ▼
┌─────────────────────┐
│   Firebase SDK      │
│   (Firestore)       │
└──────┬──────────────┘
       │
       │ 7. Writes to Firestore
       ▼
┌─────────────────────┐
│   Firestore Cloud   │
│   Database          │
└──────┬──────────────┘
       │
       │ 8. Triggers onSnapshot
       │ 9. Updates all listeners
       ▼
┌─────────────────────┐
│  Angular Component  │
│  (Receives update)  │
└──────┬──────────────┘
       │
       │ 10. Updates UI
       ▼
┌─────────────┐
│   User      │
│  Interface  │
│ (Sees new   │
│  message)   │
└─────────────┘
```

---

## Security Considerations

1. **Authentication**: Always authenticate users before allowing Firestore access
2. **Validation**: Validate message content on both client and server (Firestore rules)
3. **Rate Limiting**: Consider implementing rate limiting for message sending
4. **Input Sanitization**: Sanitize user input to prevent XSS attacks
5. **Firestore Rules**: Implement strict security rules for read/write operations

---

## Performance Considerations

1. **Pagination**: For large message histories, consider implementing pagination
2. **Message Limits**: Current implementation loads all messages; consider limiting to last N messages
3. **Caching**: Firestore SDK handles caching automatically
4. **Offline Support**: Firestore provides offline persistence by default

---

## Version Information

- **Document Version**: 1.0
- **Last Updated**: 2024
- **Angular Version**: 17+
- **Firebase SDK Version**: 10+

---

## Support & Troubleshooting

### Common Issues

1. **Messages not appearing**: Check Firestore security rules and authentication
2. **Real-time updates not working**: Verify onSnapshot listener is properly set up
3. **Permission errors**: Ensure user is authenticated and has proper permissions
4. **Collection path errors**: Verify `__app_id` is correctly set

### Debugging Tips

1. Enable Firestore debug logging: `firebase.firestore.setLogLevel('debug')`
2. Check browser console for Firebase errors
3. Verify global variables are set before component initialization
4. Test Firestore rules using the Firebase Console Rules Playground

---

**End of Documentation**

